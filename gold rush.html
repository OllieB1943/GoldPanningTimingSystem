<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Panning National Championship</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Professional Aesthetic - Color Palette */
        :root {
            --color-background-primary: #1e2a38; /* Dark, desaturated blue-grey */
            --color-background-secondary: #2c3a4d; /* Slightly lighter, complementary dark blue-grey for cards */
            --color-accent-bronze: #c0a273; /* Muted, sophisticated bronze */
            --color-text-light: #e0e6eb; /* Light grey-blue for primary text */
            --color-text-medium: #aab7c4; /* Medium grey-blue for secondary text */
            --color-button-primary: #c0a273; /* Bronze for primary buttons */
            --color-button-primary-hover: #a1835b; /* Darker bronze on hover */
            --color-button-secondary: #6c7a89; /* Cooler grey for secondary buttons */
            --color-button-secondary-hover: #546270; /* Darker grey on hover */
            --color-error-red: #e74c3c; /* Professional red for errors/stop */
            --color-error-red-hover: #c0392b; /* Darker red on hover */
            --color-disabled: #4a5a6b; /* Dark grey for disabled states */
            --color-input-bg: #3c4b5e; /* Darker input background */
            --color-input-border: #4a5a6b; /* Input border color */
            --color-border-subtle: rgba(255, 255, 255, 0.1); /* Subtle white for dividers */
        }

        /* Base styles */
        body {
            background-color: var(--color-background-primary);
            color: var(--color-text-light);
            font-family: Inter, sans-serif;
            margin: 0;
            padding: 30px; /* Increased body padding */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* Responsive container for all content */
        #app-container {
            width: 100%;
            max-width: 1080px; /* Even wider max-width for more breathing room */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 50px; /* Increased spacing between major sections */
        }

        /* General card/section styling */
        .section-card {
            background-color: var(--color-background-secondary);
            border-radius: 18px; /* Slightly larger, consistent border-radius */
            padding: 35px; /* Generous padding */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); /* Stronger, deeper shadow */
            width: 100%;
            box-sizing: border-box;
        }
        .section-card h2, .section-card h3 {
            color: var(--color-accent-bronze);
            text-align: center;
            margin-bottom: 30px; /* Generous margin below headings */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        .section-card h2 { font-size: 3.2rem; } /* Larger section titles */
        .section-card h3 { font-size: 2.2rem; } /* Larger sub-titles */


        /* Header styling */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            flex-wrap: wrap;
            gap: 30px; /* Increased space between title and badge */
            margin-bottom: 30px; /* Spacing below header */
        }
        .app-title {
            color: var(--color-background-primary); /* Dark text on bronze */
            font-size: 3.5rem; /* Larger title font */
            background-color: var(--color-accent-bronze);
            padding: 20px 30px; /* Increased padding */
            border-radius: 18px; /* Consistent border-radius */
            text-align: center;
            flex-grow: 1;
            margin: 0;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.45); /* Enhanced shadow for title */
        }
        .heat-badge {
            background: var(--color-background-secondary);
            color: var(--color-accent-bronze);
            border: 2px solid var(--color-accent-bronze);
            padding: 15px 25px; /* Increased padding */
            border-radius: 20px; /* Larger border-radius */
            font-weight: 900;
            font-size: 1.3rem; /* Slightly larger font */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            white-space: nowrap; /* Prevent badge text from wrapping */
        }

        /* Inputs */
        input[type="text"], input[type="number"] {
            background-color: var(--color-input-bg);
            color: var(--color-text-light);
            border: 1px solid var(--color-input-border);
            padding: 18px 20px; /* Generous input padding */
            border-radius: 12px;
            font-weight: normal;
            font-size: 1.15rem; /* Slightly larger font size */
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px; /* Increased margin */
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3); /* Inner shadow for depth */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input::placeholder {
            color: var(--color-text-medium);
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        input:focus {
            outline: none;
            border-color: var(--color-accent-bronze);
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.4), 0 0 0 3px rgba(192, 162, 115, 0.3); /* Focus ring */
        }

        /* Buttons */
        button {
            background-color: var(--color-button-primary); /* Bronze button */
            color: var(--color-background-primary); /* Dark text on bronze */
            padding: 18px 25px; /* Generous button padding */
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.15rem;
            border: none;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px; /* Increased margin */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }
        button:hover:not(:disabled) {
            background-color: var(--color-button-primary-hover);
            transform: translateY(-4px); /* More pronounced lift effect */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }
        button:disabled {
            background-color: var(--color-disabled);
            color: var(--color-text-medium);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Specific button variants */
        .stop-button {
            background-color: var(--color-error-red);
            color: var(--color-text-light);
            border: 2px solid var(--color-error-red);
            border-radius: 10px;
            padding: 12px 20px;
            font-weight: 900;
            margin-top: 25px; /* More margin */
            max-width: 220px; /* Wider stop buttons */
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        .stop-button:hover:not(:disabled) {
            background-color: var(--color-error-red-hover);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        .stop-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            border: 3px solid var(--color-accent-bronze);
            border-radius: 12px;
            background-color: var(--color-background-primary);
            height: 40px; /* Taller progress bar */
            margin: 25px 0; /* Increased margin */
            position: relative;
            text-align: center;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4); /* Deeper inner shadow */
        }
        .progress-bar-fill {
            background-color: var(--color-accent-bronze);
            height: 100%;
            width: 0;
            transition: width 0.1s linear;
            position: absolute;
            top: 0;
            left: 0;
        }
        .progress-text {
            position: relative;
            line-height: 40px; /* Vertically center text */
            color: var(--color-background-primary); /* Dark text on bronze fill */
            font-weight: bold;
            font-size: 1.1rem; /* Clearer text */
            z-index: 1;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7); /* Stronger text shadow for readability */
        }

        /* Grid Layouts for stopwatches and scoreboard items */
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* Adjusted min-width for more space */
            gap: 35px; /* Increased gap */
            width: 100%;
        }

        /* Individual Stopwatch Card */
        .stopwatch-card {
            background-color: var(--color-background-secondary); /* Darker background for cards */
            color: var(--color-text-light); /* Light text on card */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 35px 25px; /* Increased padding */
            text-align: center;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-radius: 15px; /* Consistent border-radius */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3); /* Subtle card shadow */
        }
        .stopwatch-card:hover:not(.disabled) {
            transform: translateY(-10px); /* More pronounced hover effect */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5); /* Stronger shadow on hover */
        }
        .stopwatch-card h3 {
            margin: 0 0 18px 0; /* Adjusted margin */
            font-size: 1.8rem; /* Larger name font */
            line-height: 1.2;
            color: var(--color-accent-bronze); /* Bronze for names */
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .stopwatch-card .time {
            font-size: 2.8rem; /* Larger time font */
            font-weight: bold;
            color: var(--color-text-light); /* Light text for time */
            line-height: 1;
            text-shadow: 0 2px 5px rgba(0,0,0,0.4); /* Stronger shadow for time */
        }
        .stopwatch-card p {
            font-size: 1.05rem;
            color: var(--color-text-medium); /* Medium grey for details */
            margin: 10px 0 0 0;
            line-height: 1.5;
        }
        .stopwatch-card strong {
             color: var(--color-text-light); /* Light text for strong values */
        }

        /* Competition controls */
        .competition-controls {
            display: flex;
            gap: 30px; /* Increased gap */
            width: 100%;
            flex-wrap: wrap;
            margin-top: 20px; /* Adjusted margin */
        }
        .competition-controls button {
            flex: 1;
            min-width: 220px; /* Minimum width for buttons */
        }

        /* Gold Collection Section */
        #gold-collection-section {
            background: var(--color-background-secondary);
            padding: 40px; /* Increased padding */
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border-radius: 18px;
            width: 100%;
        }
        #gold-collection-section h3 {
            color: var(--color-accent-bronze);
            margin-bottom: 40px; /* Increased margin */
            font-size: 2.5rem; /* Larger font size */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        #gold-collection-form div {
            margin-bottom: 30px; /* Increased margin */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gold-collection-form label {
            margin-bottom: 12px; /* Increased margin */
            font-size: 1.25rem; /* Larger label font */
            color: var(--color-text-light);
            text-shadow: 0 1px 1px rgba(0,0,0,0.3);
        }
        #gold-collection-form input[type="number"] {
            max-width: 250px; /* Wider input for gold count */
            font-size: 1.25rem;
            text-align: center;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        #submit-gold-collection-button {
            margin-top: 25px;
        }

        /* Scoreboard Section */
        #scoreboard-section {
            background: var(--color-background-primary); /* Match body background */
            padding: 40px; /* Increased padding */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6); /* Even stronger shadow */
            border-radius: 18px;
            width: 100%;
        }
        #scoreboard-section h2 {
            color: var(--color-accent-bronze);
            margin-bottom: 40px;
            font-size: 3.5rem;
            text-align: center;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }
        #scoreboard-section .category-header { /* General header for top/other miners */
            background-color: var(--color-background-secondary);
            border-radius: 12px;
            padding: 20px 25px; /* Adjusted padding */
            margin-bottom: 25px; /* Increased margin */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        #scoreboard-section .category-header h3 {
            font-size: 2.2rem;
            margin: 0;
            color: var(--color-accent-bronze);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        #podium-display, #others-display {
            gap: 30px; /* Consistent gap in scoreboard grids */
        }
        #save-results-button, #next-heat-button {
            margin-top: 40px; /* Increased margin for scoreboard buttons */
        }

        /* Previous Heat Results Section */
        #previous-heat-results-section {
            width: 100%;
            max-width: 1080px;
            background-color: var(--color-background-secondary);
            border-radius: 18px;
            padding: 40px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
            margin-top: 50px; /* More spacing from above */
        }
        #previous-heat-results-section h2 {
            color: var(--color-accent-bronze);
            font-size: 3rem;
            text-align: center;
            margin-bottom: 35px;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
        }
        .heat-summary-item {
            background-color: var(--color-background-primary); /* Darker background for summary item */
            border-radius: 15px;
            padding: 22px 28px;
            margin-bottom: 25px; /* Increased margin */
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .heat-summary-item:hover {
            background-color: #263445; /* Slightly lighter on hover */
            transform: translateY(-5px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.45);
        }
        .heat-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.3rem; /* Larger font */
            font-weight: bold;
            color: var(--color-text-light);
            margin-bottom: 10px; /* Adjusted margin */
            line-height: 1.4;
        }
        .heat-toggle-icon {
            font-size: 1.6rem; /* Larger icon */
            transition: transform 0.2s ease;
            color: var(--color-accent-bronze); /* Bronze arrow */
        }
        .heat-summary-item.expanded .heat-toggle-icon {
            transform: rotate(90deg);
        }
        .heat-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, margin 0.3s ease-out;
            color: var(--color-text-medium);
            font-size: 1.05rem; /* Clearer details font */
            line-height: 1.7; /* More spacious line height */
            padding-left: 20px; /* Increased padding */
            border-left: 3px solid var(--color-accent-bronze); /* Thicker border */
            margin-top: 0;
            padding-top: 0;
        }
        .heat-summary-item.expanded .heat-details {
            max-height: 600px; /* Adjust as needed for content */
            padding-top: 20px; /* Increased padding */
            margin-top: 20px; /* Increased margin */
        }
        .heat-details strong { color: var(--color-text-light); }

        /* Custom Message Box (overlay) */
        .custom-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--color-background-secondary);
            color: var(--color-text-light);
            padding: 40px; /* Increased padding */
            border-radius: 18px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7); /* Stronger shadow for pop-up */
            max-width: 550px; /* Wider message box */
            width: 90%;
            z-index: 2000;
        }
        .custom-message-box h3 {
            color: var(--color-accent-bronze);
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
        }
        .custom-message-box p {
            margin-bottom: 35px;
            font-size: 1.2rem; /* Larger message text */
            line-height: 1.6; /* Improved line height */
            color: var(--color-text-medium);
        }
        .custom-message-box button {
            max-width: 220px;
            margin: 0 auto;
            display: block;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Utility classes */
        .hidden { display: none !important; }

        /* Styles for the new name input/list */
        .name-input-group {
            display: flex;
            gap: 25px; /* Increased gap */
            width: 100%;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .name-input-group input {
            flex-grow: 1;
            margin-bottom: 0;
            min-width: 250px; /* Minimum width for input */
        }
        .name-input-group button {
            width: auto;
            min-width: 160px; /* Wider add button */
            margin-bottom: 0;
        }
        #added-names-list {
            list-style: none;
            padding: 0;
            margin-top: 20px; /* Increased margin */
            text-align: left;
            width: 100%;
            max-height: 280px; /* Taller scrollable list */
            overflow-y: auto;
            border: 2px solid var(--color-input-border);
            border-radius: 12px;
            background-color: var(--color-input-bg);
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        #added-names-list li {
            padding: 15px 20px; /* Increased padding */
            border-bottom: 1px solid var(--color-border-subtle); /* Subtle separator */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem; /* Larger text for names */
            color: var(--color-text-light);
        }
        #added-names-list li:last-child { border-bottom: none; }
        #added-names-list li .remove-name-button {
            background-color: var(--color-error-red);
            color: var(--color-text-light);
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 0.9rem;
            font-weight: normal;
            cursor: pointer;
            width: auto;
            margin-bottom: 0;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #added-names-list li .remove-name-button:hover {
            background-color: var(--color-error-red-hover);
            transform: translateY(-2px);
        }


        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            body { padding: 20px; }
            #app-container { gap: 35px; }
            .app-title { font-size: 2.5rem; padding: 18px 20px; }
            .heat-badge { font-size: 1.1rem; padding: 12px 20px; border-radius: 16px; }
            .header { flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px; }
            input[type="text"], input[type="number"], button { font-size: 1rem; padding: 15px 18px; min-height: 55px; margin-bottom: 15px; }
            .stop-button { max-width: 100%; margin-top: 20px; }
            .progress-bar-container { height: 35px; margin: 20px 0; }
            .progress-text { font-size: 0.95rem; line-height: 35px; }
            .grid-layout { grid-template-columns: 1fr; gap: 25px; }
            .stopwatch-card { padding: 30px 20px; }
            .stopwatch-card h3 { font-size: 1.6rem; margin-bottom: 15px; }
            .stopwatch-card .time { font-size: 2.5rem; }
            .stopwatch-card p { font-size: 1rem; margin-top: 8px; }
            .competition-controls { flex-direction: column; gap: 15px; margin-top: 15px; }
            .section-card { padding: 30px; border-radius: 15px; }
            .section-card h2 { font-size: 2.5rem; margin-bottom: 25px; }
            .section-card h3 { font-size: 1.8rem; margin-bottom: 30px; }
            #gold-collection-section h3 { font-size: 2rem; margin-bottom: 30px; }
            #gold-collection-form div { margin-bottom: 20px; }
            #gold-collection-form label { font-size: 1.1rem; margin-bottom: 10px; }
            #gold-collection-form input[type="number"] { max-width: 100%; font-size: 1.1rem; }
            #submit-gold-collection-button { margin-top: 20px; }
            #scoreboard-section h2 { font-size: 2.8rem; margin-bottom: 30px; }
            #scoreboard-section .category-header { padding: 18px 20px; margin-bottom: 20px; border-radius: 10px; }
            #scoreboard-section .category-header h3 { font-size: 1.8rem; }
            #save-results-button, #next-heat-button { margin-top: 30px; }
            #previous-heat-results-section { padding: 30px; margin-top: 35px; border-radius: 15px; }
            #previous-heat-results-section h2 { font-size: 2.5rem; margin-bottom: 30px; }
            .heat-summary-item { padding: 20px 25px; margin-bottom: 20px; border-radius: 12px; }
            .heat-summary-header { font-size: 1.15rem; margin-bottom: 8px; }
            .heat-toggle-icon { font-size: 1.4rem; }
            .heat-details { font-size: 1rem; padding-left: 15px; border-left-width: 2px; margin-top: 10px; padding-top: 10px; }
            .custom-message-box { padding: 30px; border-radius: 15px; }
            .custom-message-box h3 { font-size: 2.2rem; margin-bottom: 25px; }
            .custom-message-box p { font-size: 1.1rem; margin-bottom: 30px; }
            .name-input-group { flex-direction: column; gap: 15px; margin-bottom: 20px; }
            .name-input-group input, .name-input-group button { width: 100%; min-width: unset; }
            #added-names-list { max-height: 220px; margin-top: 15px; border-width: 2px; }
            #added-names-list li { font-size: 1rem; padding: 12px 18px; }
            #added-names-list li .remove-name-button { padding: 7px 10px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1 class="app-title">🎉 Gold Panning National Championship! 🎉</h1>
        <div class="heat-badge">HEAT <span id="heat-number">1</span></div>
    </div>

    <div id="app-container">
        <!-- Section 1: Setup - Always visible initially -->
        <div id="setup-section" class="section-card">
            <h3>Set Up Your Championship Heat!</h3>
            <div class="name-input-group">
                <input type="text" id="name-input-field" placeholder="Enter miner's name">
                <button id="add-name-button">Add Miner</button>
            </div>
            <ul id="added-names-list">
                <!-- Names will be dynamically added here -->
            </ul>
            <input type="number" id="gold-input" placeholder="Total gold specks in bucket (e.g., 10)" min="0">
            <button id="submit-setup-button">Start Competition</button>
        </div>

        <!-- Section 2: Competition - Hidden until setup is submitted -->
        <div id="competition-section" class="section-card hidden">
            <!-- Countdown Overlay -->
            <div id="countdown-display" class="app-title hidden" style="font-size: 80px;"></div>

            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progress-fill"></div>
                <div class="progress-text" id="progress-text"></div>
            </div>
            <div id="stopwatch-grid" class="grid-layout"></div>
            <div class="competition-controls">
                <button id="start-all-button">Start All • Heat <span id="start-all-heat-display">1</span></button>
                <button id="stop-all-button" class="hidden">Stop All Now</button>
            </div>
        </div>

        <!-- Section 3: Gold Collection - Hidden until competition ends -->
        <div id="gold-collection-section" class="section-card hidden">
            <h3>Enter Gold Collected per Miner:</h3>
            <form id="gold-collection-form"></form>
            <button id="submit-gold-collection-button">Submit Gold</button>
        </div>

        <!-- Section 4: Scoreboard - Hidden until gold collection is submitted -->
        <div id="scoreboard-section" class="section-card hidden">
            <h2 id="scoreboard-title"></h2>
            <div class="category-header"><h3>Top Miners</h3></div>
            <div id="podium-display" class="grid-layout"></div>
            <div class="category-header" style="margin-top: 35px;"><h3>Other Miners</h3></div>
            <div id="others-display" class="grid-layout"></div>
            <button id="save-results-button" style="margin-top: 35px;">Save Results as Spreadsheet 📥</button>
            <button id="next-heat-button" style="margin-top: 15px;">Start Next Heat</button>
        </div>

        <!-- Section 5: Previous Heat Results - Visible after first heat, populated from local storage -->
        <div id="previous-heat-results-section" class="section-card hidden">
            <h2>Previous Heat Results</h2>
            <div id="all-heat-results-list">
                <!-- Previous heats will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Custom Message Box (replaces browser alert/confirm) -->
    <div class="custom-message-box hidden">
        <h3 class="custom-message-title"></h3>
        <p class="custom-message-content"></p>
        <button class="custom-message-ok">OK</button>
    </div>

    <script>
        // --- Constants & Global State ---
        const TIME_LIMIT_MS = 5 * 60 * 1000; // 5 minutes in milliseconds
        const PENALTY_PER_MISS_MS = 5_000; // 5 seconds penalty per missing gold speck
        const LOCAL_STORAGE_KEY = 'goldMiningChampionshipResults'; // Key for local storage

        // Centralized application state
        const appState = {
            currentCompetitorNames: [], // New: to hold names added one by one for the current heat
            stopwatches: [], // Array of Stopwatch instances for the current heat
            results: [], // Stores { name, initialElapsed, gold, finalElapsed, goldMissed, penaltyApplied } for current heat
            goldInBucket: 0,
            heatNumber: 1, // Start at Heat 1
            competitionTimerStartTime: null, // Date.now() when heat officially starts
            progressIntervalId: null, // ID for the progress bar's update interval
            allHeatResults: [] // Array to store results from ALL completed heats
        };

        // --- Tone.js Setup for Sound Effects ---
        // Initialize a simple synth for the countdown tick
        const tickSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: {
                type: "sine"
            },
            envelope: {
                attack: 0.01,
                decay: 0.1,
                sustain: 0.05,
                release: 0.1
            }
        }).toDestination();

        // Initialize a slightly different synth for the "go" sound
        const goSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: {
                type: "triangle"
            },
            envelope: {
                attack: 0.02,
                decay: 0.2,
                sustain: 0.1,
                release: 0.2
            }
        }).toDestination();

        // --- DOM Element References ---
        const heatNumberSpan = document.getElementById('heat-number');
        const appTitle = document.querySelector('.app-title');

        // Section containers
        const setupSection = document.getElementById('setup-section');
        const competitionSection = document.getElementById('competition-section');
        const goldCollectionSection = document.getElementById('gold-collection-section');
        const scoreboardSection = document.getElementById('scoreboard-section');
        const previousHeatResultsSection = document.getElementById('previous-heat-results-section'); // New section

        // Setup elements
        const nameInputField = document.getElementById('name-input-field');
        const addNameButton = document.getElementById('add-name-button');
        const addedNamesList = document.getElementById('added-names-list');
        const goldInput = document.getElementById('gold-input');
        const submitSetupButton = document.getElementById('submit-setup-button');

        // Competition elements
        const countdownDisplay = document.getElementById('countdown-display');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const stopwatchGrid = document.getElementById('stopwatch-grid');
        const startAllButton = document.getElementById('start-all-button');
        const startAllHeatDisplay = document.getElementById('start-all-heat-display');
        const stopAllButton = document.getElementById('stop-all-button');

        // Gold Collection elements
        const goldCollectionForm = document.getElementById('gold-collection-form');
        const submitGoldCollectionButton = document.getElementById('submit-gold-collection-button');

        // Scoreboard elements
        const scoreboardTitle = document.getElementById('scoreboard-title');
        const podiumDisplay = document.getElementById('podium-display');
        const othersDisplay = document.getElementById('others-display');
        const saveResultsButton = document.getElementById('save-results-button');
        const nextHeatButton = document.getElementById('next-heat-button');

        // Previous Heat Results elements
        const allHeatResultsList = document.getElementById('all-heat-results-list'); // New element

        // Custom message box elements
        const customMessageBox = document.querySelector('.custom-message-box');
        const customMessageTitle = customMessageBox.querySelector('.custom-message-title');
        const customMessageContent = customMessageBox.querySelector('.custom-message-content');
        const customMessageOkBtn = customMessageBox.querySelector('.custom-message-ok');

        // --- Helper Functions ---

        /** Loads all previous heat results from local storage. */
        const loadAllHeatResults = () => {
            const storedResults = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedResults) {
                appState.allHeatResults = JSON.parse(storedResults);
                if (appState.allHeatResults.length > 0) {
                    // Set next heat number based on highest heat number found
                    const maxHeatNum = Math.max(...appState.allHeatResults.map(h => h.heatNumber));
                    appState.heatNumber = maxHeatNum + 1;
                }
            }
        };

        /** Saves the current allHeatResults to local storage. */
        const saveAllHeatResults = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState.allHeatResults));
        };

        /** Updates the displayed heat number across the UI. */
        const updateHeatNumberDisplays = () => {
            heatNumberSpan.textContent = appState.heatNumber;
            startAllHeatDisplay.textContent = appState.heatNumber;
            scoreboardTitle.textContent = `🏆 Gold Panning National Championship — Heat ${appState.heatNumber} �`;
        };

        /** Returns medal emoji based on rank. */
        const getMedalEmoji = i => ["🥇", "🥈", "🥉"][i] || "";

        /** Formats milliseconds into MM:SS.mmm string. */
        const formatTimeMs = ms => {
            if (ms < 0) ms = 0; // Prevent negative time display
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = ms % 1000;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
        };

        /** Adds 'hidden' class to an element. */
        const hideElement = el => el.classList.add('hidden');
        /** Removes 'hidden' class from an element. */
        const showElement = el => el.classList.remove('hidden');

        /**
         * Displays a custom message box instead of native browser alerts.
         * @param {string} title The title of the message box.
         * @param {string} message The content message.
         * @param {function} [callback=null] An optional function to call when 'OK' is clicked.
         */
        function showCustomMessage(title, message, callback = null) {
            customMessageTitle.textContent = title;
            customMessageContent.textContent = message;
            showElement(customMessageBox);

            customMessageOkBtn.onclick = () => {
                hideElement(customMessageBox);
                if (callback) callback();
            };
        }

        // --- Stopwatch Class (Frontend) ---
        class Stopwatch {
            constructor(name, onStoppedCallback) {
                this.name = name;
                this.elapsedTime = 0;
                this.startTime = 0;
                this.isRunning = false;
                this.intervalId = null;
                this.onStoppedCallback = onStoppedCallback;

                this.element = this.createDomElement();
            }

            createDomElement() {
                const card = document.createElement('div');
                card.className = 'stopwatch-card section-card'; /* Use general section-card for consistent styling */

                this.nameLabel = document.createElement('h3');
                this.nameLabel.textContent = this.name;

                this.timeLabel = document.createElement('div');
                this.timeLabel.className = 'time';
                this.timeLabel.textContent = '00:00.000';

                this.stopButton = document.createElement('button');
                this.stopButton.className = 'stop-button';
                this.stopButton.textContent = 'STOP';
                this.stopButton.disabled = true;
                this.stopButton.onclick = () => this.stop();

                card.append(this.nameLabel, this.timeLabel, this.stopButton);
                return card;
            }

            start() {
                if (!this.isRunning) {
                    this.startTime = Date.now() - this.elapsedTime;
                    this.isRunning = true;
                    this.stopButton.disabled = false;
                    this.intervalId = setInterval(() => {
                        this.elapsedTime = Date.now() - this.startTime;
                        this.timeLabel.textContent = formatTimeMs(this.elapsedTime);
                    }, 10);
                }
            }

            stop() {
                if (this.isRunning) {
                    clearInterval(this.intervalId);
                    this.isRunning = false;
                    this.stopButton.disabled = true;
                    this.onStoppedCallback(this.name, this.elapsedTime);
                }
            }
        }

        // --- Main Application Logic & Event Handlers ---

        /** Initializes the UI on load. */
        const initializeUI = () => {
            loadAllHeatResults(); // Load previous results on start
            updateHeatNumberDisplays();
            // Hide all sections except setup initially
            hideElement(competitionSection);
            hideElement(goldCollectionSection);
            hideElement(scoreboardSection);
            hideElement(countdownDisplay);
            renderAddedNames(); // Display any names if they were somehow present (should be empty)
            renderAllHeatResults(); // Render previous heat results
        };

        /** Handles adding a single miner name to the list. */
        addNameButton.onclick = () => {
            const name = nameInputField.value.trim();
            if (!name) {
                showCustomMessage("Input Error", "Please enter a miner's name.");
                return;
            }
            if (appState.currentCompetitorNames.includes(name)) {
                showCustomMessage("Duplicate Name", `"${name}" has already been added.`);
                return;
            }

            appState.currentCompetitorNames.push(name);
            nameInputField.value = ''; // Clear input field
            nameInputField.focus(); // Keep focus on the input for quick adding
            renderAddedNames(); // Update the displayed list
        };

        /** Renders (or re-renders) the list of added names. */
        const renderAddedNames = () => {
            addedNamesList.innerHTML = ''; // Clear current list
            if (appState.currentCompetitorNames.length === 0) {
                addedNamesList.innerHTML = '<li style="color: var(--color-text-medium);">No miners added yet.</li>';
                submitSetupButton.disabled = true; // Disable submit if no names
                return;
            }
            submitSetupButton.disabled = false; // Enable submit if names exist

            appState.currentCompetitorNames.forEach((name, index) => {
                const li = document.createElement('li');
                li.textContent = name;

                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.className = 'remove-name-button';
                // Using a closure to capture the correct index for removal
                removeButton.onclick = () => {
                    appState.currentCompetitorNames.splice(index, 1); // Remove name from array
                    renderAddedNames(); // Re-render the list
                };
                li.appendChild(removeButton);
                addedNamesList.appendChild(li);
            });
        };


        /** Handles submission of names (from the list) and gold input. */
        submitSetupButton.onclick = () => {
            const goldAmount = parseInt(goldInput.value);

            if (appState.currentCompetitorNames.length === 0) {
                showCustomMessage("Input Error", "Please add at least one miner.");
                return;
            }
            if (isNaN(goldAmount) || goldAmount < 0) {
                showCustomMessage("Invalid Input", "Please enter a valid non-negative number for total gold specks.");
                return;
            }
            appState.goldInBucket = goldAmount;

            hideElement(setupSection); // Hide setup form
            setupStopwatches(appState.currentCompetitorNames); // Initialize stopwatches using the collected names
            showElement(competitionSection); // Show competition area
            startAllButton.disabled = false; // Enable "Start All" button
        };

        /** Creates and displays stopwatch widgets for each competitor. */
        const setupStopwatches = (names) => {
            stopwatchGrid.innerHTML = ''; // Clear any existing stopwatches
            appState.stopwatches = names.map(name => new Stopwatch(name, handleStopwatchStopped));
            appState.stopwatches.forEach(sw => stopwatchGrid.appendChild(sw.element));
        };

        /** Initiates a 3-second countdown before starting all stopwatches. */
        const beginCountdownSequence = async () => {
            if (startAllButton.disabled) return; // Prevent multiple countdowns
            startAllButton.disabled = true; // Disable button immediately

            // Tone.js needs to be started from a user interaction
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }

            let count = 3;
            countdownDisplay.textContent = count;
            showElement(countdownDisplay); // Show the countdown overlay

            const countdownInterval = setInterval(() => {
                if (count > 0) {
                    tickSynth.triggerAttackRelease("C4", "8n"); // Play a tick sound
                    countdownDisplay.textContent = count;
                    count--;
                } else {
                    clearInterval(countdownInterval);
                    goSynth.triggerAttackRelease(["E5", "G5"], "4n"); // Play a "go" chord
                    hideElement(countdownDisplay); // Hide countdown
                    startAllStopwatches(); // Start the competition
                }
            }, 1000); // Update every second
        };
        // Assign the new countdown sequence to the button click
        startAllButton.onclick = beginCountdownSequence;

        /** Starts all active stopwatches and the global competition timer. */
        const startAllStopwatches = () => {
            appState.results = []; // Clear previous results for current heat
            appState.stopwatches.forEach(sw => sw.start()); // Start each individual stopwatch

            hideElement(startAllButton); // Hide "Start All"
            showElement(stopAllButton); // Show "Stop All"

            appState.competitionTimerStartTime = Date.now(); // Record actual competition start time
            appState.progressIntervalId = setInterval(updateProgressBar, 100); // Update progress bar
        };

        /** Stops all active stopwatches. */
        stopAllButton.onclick = () => {
            appState.stopwatches.forEach(sw => sw.stop());
        };

        /** Updates the progress bar and checks for time limit expiry. */
        const updateProgressBar = () => {
            const elapsed = Date.now() - appState.competitionTimerStartTime;
            const percent = (elapsed / TIME_LIMIT_MS) * 100;

            progressFill.style.width = `${Math.min(percent, 100)}%`;
            progressText.textContent = `Time Remaining: ${formatTimeMs(TIME_LIMIT_MS - elapsed)}`;

            if (elapsed >= TIME_LIMIT_MS) {
                clearInterval(appState.progressIntervalId);
                showCustomMessage("Time is Up!", "⏰ The 5-minute timer has run out! All stopwatches have been stopped.");
                appState.stopwatches.forEach(sw => sw.stop());
            }
        };

        /** Callback for when an individual stopwatch stops. */
        const handleStopwatchStopped = (name, elapsed) => {
            // Find if the competitor already exists in results (e.g., if stopped and restarted)
            let existingResult = appState.results.find(r => r.name === name);

            if (existingResult) {
                // Update existing result if stopwatch was stopped again
                existingResult.initialElapsed = elapsed;
                // Recalculate final time based on new initialElapsed
                const goldMissed = Math.max(0, existingResult.goldInBucket - existingResult.gold);
                const penaltyApplied = goldMissed * PENALTY_PER_MISS_MS;
                existingResult.goldMissed = goldMissed;
                existingResult.penaltyApplied = penaltyApplied;
                existingResult.finalElapsed = existingResult.initialElapsed + penaltyApplied;
            } else {
                // Add new result if first time stopping
                appState.results.push({
                    name,
                    initialElapsed: elapsed,
                    gold: 0, // Will be set during gold collection
                    finalElapsed: elapsed,
                    goldInBucket: appState.goldInBucket, // Store total gold in bucket for this heat
                    goldMissed: 0,
                    penaltyApplied: 0
                });
            }

            // Check if all stopwatches have stopped
            if (appState.results.length === appState.stopwatches.length) {
                clearInterval(appState.progressIntervalId);
                hideElement(competitionSection);
                collectGoldData(); // Proceed to collect gold data
            }
        };

        /** Displays the gold collection form. */
        const collectGoldData = () => {
            goldCollectionForm.innerHTML = '';
            // Sort appState.results by initialElapsed to maintain consistent order in gold collection
            appState.results.sort((a, b) => a.initialElapsed - b.initialElapsed);

            appState.results.forEach(result => {
                const div = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = `${result.name} collected:`;

                const input = document.createElement('input');
                input.type = 'number';
                input.min = 0;
                input.max = appState.goldInBucket; // Set max attribute for client-side validation
                input.value = result.gold; // Pre-fill with existing gold if any
                input.dataset.name = result.name;

                div.append(label, input);
                goldCollectionForm.appendChild(div);
            });
            showElement(goldCollectionSection);
        };

        /** Applies time penalties based on gold collected and displays the scoreboard. */
        submitGoldCollectionButton.onclick = () => {
            const goldCollected = {};
            let validationFailed = false;

            goldCollectionForm.querySelectorAll('input').forEach(input => {
                const collected = parseInt(input.value) || 0;
                const minerName = input.dataset.name;

                // Client-side validation: Check if collected gold exceeds goldInBucket
                if (collected > appState.goldInBucket) {
                    showCustomMessage("Input Error", `${minerName} cannot have collected more gold (${collected}) than was in the bucket (${appState.goldInBucket}). Please adjust.`);
                    validationFailed = true;
                    return; // Stop processing this loop for validation failure
                }
                goldCollected[minerName] = collected;
            });

            if (validationFailed) {
                return; // Stop submission if validation failed
            }

            appState.results.forEach(result => {
                const collected = goldCollected[result.name];
                const goldMissed = Math.max(0, appState.goldInBucket - collected);
                const penaltyApplied = goldMissed * PENALTY_PER_MISS_MS;

                result.gold = collected;
                result.goldMissed = goldMissed;
                result.penaltyApplied = penaltyApplied;
                result.finalElapsed = result.initialElapsed + penaltyApplied; // Calculate final time
            });

            hideElement(goldCollectionSection);
            showScoreboard();
        };

        /** Displays the final scoreboard. */
        const showScoreboard = () => {
            showCustomMessage("Competition Over", "Competition over! Showing scoreboard now...");

            // Sort results by final elapsed time (fastest first)
            const sortedResults = [...appState.results].sort((a, b) => a.finalElapsed - b.finalElapsed);

            podiumDisplay.innerHTML = '';
            othersDisplay.innerHTML = '';

            // Clear content of sections for clarity
            podiumDisplay.textContent = '';
            othersDisplay.textContent = '';

            sortedResults.forEach((result, i) => {
                const formattedTime = formatTimeMs(result.finalElapsed);
                const card = document.createElement('div');
                card.className = 'stopwatch-card section-card'; // Use general section-card for consistent styling

                const nameLabel = document.createElement('h3');
                nameLabel.textContent = `${getMedalEmoji(i)} ${result.name}`;

                const timeLabel = document.createElement('div');
                timeLabel.className = 'time';
                timeLabel.textContent = formattedTime;

                // Add detailed penalty information to the card
                const details = document.createElement('div');
                details.innerHTML = `
                    <p>Total Gold in Bucket: <strong>${result.goldInBucket}</strong></p>
                    <p>Gold Collected: <strong>${result.gold}</strong></p>
                    <p>Gold Missed: <strong>${result.goldMissed}</strong></p>
                    <p>Penalty: <strong>${formatTimeMs(result.penaltyApplied)}</strong></p>
                `;

                card.append(nameLabel, timeLabel, details); // Append new details

                if (i < 3) {
                    podiumDisplay.appendChild(card);
                } else {
                    othersDisplay.appendChild(card); // Others use the same card styling
                }
            });

            showElement(scoreboardSection);

            // Store this heat's results in allHeatResults and save to local storage
            appState.allHeatResults.push({
                heatNumber: appState.heatNumber,
                timestamp: new Date().toLocaleString(),
                goldInBucket: appState.goldInBucket, // Also store gold in bucket for the heat summary
                results: appState.results // Store the full results array for this heat
            });
            saveAllHeatResults(); // Save to local storage
            renderAllHeatResults(); // Update the previous heat results display
        };

        /** Downloads results as a CSV spreadsheet. */
        saveResultsButton.onclick = () => {
            const sortedResults = [...appState.results].sort((a, b) => a.finalElapsed - b.finalElapsed);

            // CSV Header with new penalty details
            let csvContent = "Rank,Medal,Name,Initial Time (MM:SS.mmm),Total Gold in Bucket,Gold Collected,Gold Missed,Penalty Applied (ms),Final Time (MM:SS.mmm)\n";

            // CSV Data
            sortedResults.forEach((r, i) => {
                const rank = i + 1;
                const medal = getMedalEmoji(i);
                const initialTime = formatTimeMs(r.initialElapsed);
                const finalTime = formatTimeMs(r.finalElapsed);
                const penaltyTimeFormatted = formatTimeMs(r.penaltyApplied);

                csvContent += `${rank},"${medal}","${r.name}",${initialTime},${r.goldInBucket},${r.gold},${r.goldMissed},${penaltyTimeFormatted},${finalTime}\n`;
            });

            // Create a Blob and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `GoldPanning_Heat${appState.heatNumber}_Results.csv`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url); // Clean up

            showCustomMessage("Save Successful", "Results saved as a CSV spreadsheet!");
        };

        /** Resets the application for the next heat. */
        nextHeatButton.onclick = () => {
            appState.heatNumber++;
            // Reset appState for new heat
            appState.currentCompetitorNames = []; // Clear names
            appState.stopwatches = [];
            appState.results = [];
            appState.goldInBucket = 0;
            appState.competitionTimerStartTime = null;
            clearInterval(appState.progressIntervalId);

            // Reset UI
            updateHeatNumberDisplays();
            nameInputField.value = ''; // Clear name input
            goldInput.value = '';
            renderAddedNames(); // Clear the displayed list of names
            progressFill.style.width = '0%';
            progressText.textContent = '';

            // Re-enable the start button and hide stop button
            startAllButton.disabled = false;
            hideElement(stopAllButton);
            showElement(startAllButton);

            // Show setup, hide others
            showElement(setupSection);
            hideElement(competitionSection);
            hideElement(goldCollectionSection);
            hideElement(scoreboardSection);

            // Re-render previous heat results in case any new ones were added
            renderAllHeatResults();
        };

        /** Renders all stored heat results in the Previous Heat Results section. */
        const renderAllHeatResults = () => {
            allHeatResultsList.innerHTML = ''; // Clear current list
            if (appState.allHeatResults.length === 0) {
                hideElement(previousHeatResultsSection);
                return;
            }
            showElement(previousHeatResultsSection);

            // Render in reverse chronological order (most recent first)
            [...appState.allHeatResults].reverse().forEach((heatData, index) => {
                const heatSummaryItem = document.createElement('div');
                heatSummaryItem.className = 'heat-summary-item';

                const heatSummaryHeader = document.createElement('div');
                heatSummaryHeader.className = 'heat-summary-header';
                heatSummaryHeader.innerHTML = `
                    <span>Heat ${heatData.heatNumber} - ${heatData.timestamp} (Gold in Bucket: ${heatData.goldInBucket})</span>
                    <span class="heat-toggle-icon">▶</span>
                `;
                heatSummaryItem.appendChild(heatSummaryHeader);

                const heatDetails = document.createElement('div');
                heatDetails.className = 'heat-details';

                // Sort results within each heat for consistent display
                const sortedHeatResults = [...heatData.results].sort((a, b) => a.finalElapsed - b.finalElapsed);

                sortedHeatResults.forEach((result, resIndex) => {
                    heatDetails.innerHTML += `
                        <p><strong>${getMedalEmoji(resIndex)} ${result.name}:</strong> ${formatTimeMs(result.finalElapsed)} (Collected: ${result.gold}, Missed: ${result.goldMissed}, Penalty: ${formatTimeMs(result.penaltyApplied)})</p>
                    `;
                });
                heatSummaryItem.appendChild(heatDetails);

                heatSummaryItem.onclick = () => {
                    heatSummaryItem.classList.toggle('expanded');
                };

                allHeatResultsList.appendChild(heatSummaryItem);
            });
        };

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            // Prevent default scrolling/other behavior for spacebar
            if (e.code === 'Space') {
                e.preventDefault();
            }

            // Handle '1' through '9' keys for stopping individual stopwatches
            if (e.key >= '1' && e.key <= '9') {
                const competitorIndex = parseInt(e.key) - 1; // 0-indexed
                if (competitionSection.classList.contains('hidden') === false && appState.stopwatches[competitorIndex] && appState.stopwatches[competitorIndex].isRunning) {
                    appState.stopwatches[competitorIndex].stop();
                    e.preventDefault(); // Prevent any default action for these number keys
                }
            }

            // Handle Spacebar for 10th competitor OR starting countdown
            if (e.code === 'Space') {
                if (competitionSection.classList.contains('hidden')) { // If competition not started, spacebar starts countdown
                    if (!startAllButton.disabled && !startAllButton.classList.contains('hidden')) {
                        beginCountdownSequence();
                    }
                } else { // If competition is active, spacebar stops 10th competitor
                    const competitorIndex = 9; // 10th competitor is at index 9
                    if (appState.stopwatches[competitorIndex] && appState.stopwatches.length > competitorIndex && appState.stopwatches[competitorIndex].isRunning) {
                        appState.stopwatches[competitorIndex].stop();
                    }
                }
            }

            // Handle Escape key to stop all stopwatches
            if (e.code === 'Escape' && !stopAllButton.classList.contains('hidden')) {
                stopAllButton.click();
            }
            // Handle Enter key for adding name if in name input field
            if (e.code === 'Enter' && nameInputField === document.activeElement) {
                e.preventDefault();
                addNameButton.click();
            }
            // Handle Enter key for submitting setup if in gold input field
            if (e.code === 'Enter' && goldInput === document.activeElement) {
                e.preventDefault();
                submitSetupButton.click();
            }
            // Handle Enter key for submitting gold collection
            if (e.code === 'Enter' && goldCollectionSection.classList.contains('hidden') === false) {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.tagName === 'INPUT' && activeElement.type === 'number') {
                    e.preventDefault(); // Prevent accidental form submission behavior if an input is focused
                    submitGoldCollectionButton.click();
                }
            }
        });

        // Initialize UI on page load
        document.addEventListener('DOMContentLoaded', initializeUI);
    </script>
</body>
</html>
�